<!--
	- chrome win: y scroll appears
	- MSIE: "onLoad" –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ
	- remove animations
	- enable scroll-by-touch on the textarea cause there is no y-scroll
	- use prefix like 't:' or ':'
	- force unix line ending?
	- go base85 ?
	- handle Ctrl/Cmd+S ?
	- pageTitle: limit length
	- pageTitle: strip punctuation
	+ total-time: adjust the light theme
	+ allow millis
	+ placeholder text blinks on frequent reload
	+ force utf8 by meta
	+ 12:09 => 12:9
	+ disallow url ending with '#'
	+ '1111111111111111111111111111' => '3.0864197530864196e+23:10:40'
	+ "11366" => "03:9:26"
	+ favicon
	+ '02' is meaningless 02:10:00:09
	+ no 'paris' in title when text is '111Paris'
	+ 'sapienza' in title when text is '111. Paris\n222 Sapienza'
	+ put some text into the title
	+ monospace everywhere
	+ textarea takes 606px
	+ use pixels everywhere, not em
-->

<!DOCTYPE html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Time Calculator</title>
<link rel="icon" type="image/png" sizes="16x16" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAABCgAwAEAAAAAQAAABAAAAAAx28c8QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAAAw5JREFUOBF1U01IVFEUvve+meeb6c0bJUUiIskWCS1EKbDSaCE0FAXFbGyhGY2jMf6gk0rQIiqtlNEGf6tFiYsaaicStQkkqDAQCTcVtXClZfNm3rxx5r17O2cmI4TO5tx7fr577jnno36/XyLbJBaL2Wjyd3W5XBnFbcrpVCwSMdEWCAScqDc2NjhqigBra2u0rKzMYRgGhzOvqKw5Db6LlJAqQYmXChIXhHwUQjyZHB18jok+n69AVVWLIiKgUXg1gw6U1s7+bzuLS/b+/LFOICnBGPOoqodkLYuYqdScnVq/MD09HcdceCQvwY6+84zRm4LbvVCYKig9wIV4aLNMUiYFhZyTkxKl11XNW5rQ4+/XVz/XwqOWI9jec5Ax+ZlDdlY4nTIxDaN7fOT28S3g1o6+CUHoytTowP1LV7rnhK7PezTvYUL234KYMBNCgiaKT9lsJpM2TUIZrQuEwuXgxOoYpayBUrIHAR+NDX+3xGZjykgSsLUGAp272FT0zhInYsztVmUu+FvO7SVGWTXEi5b2cLlTljU4ryJAc3Oz58Ho8AfbtuZVVdshuZRjDB0gtbJcQAgX8xMjg5UWTb9BI5McR1xuNxFE6HhXFAWGASLooiQ54MD25QCgzix0G+xCQb8Vj8dRE0usWtksYYSdwWsi4c4D4AUEM3IA3OZfoSz8dBU6DKOI+kKhgono4Gv4b6+qaWfb2q+emJkZMtBPqKi2cvHiSw4gw8WCkdANKMt3uaP7UCwWMVXbdjY1NSnjIwN3E/qvp4JKRzG3pbOnBuMw3jbTCzQEL0Wj0U1Ynnswnp6Erq+ItFk/ORnJNQ6TtiQY7NpNFdcrj6ZVwC4MTYwMhB3Ly8u49wwW4xrMtg5nnCRisaWj7wYs1cssSesyVQolKtXD7GCRtNKkHn+Xj4cx/yGThKsMq+mV3MWz0PlTToeDJJMJwjnftsrJOd02GmajUT23yltkKikpYVt8aOvsPwftbsSmgvaCzpEJ9GPoyQv80l8y/UvnoqKiXFOBKFkMytM5A3SW/0vn3xA8duspEnNgAAAAAElFTkSuQmCC" />
<style type="text/css">

/* css reset */
a,abbr,acronym,address,applet,article,aside,audio,b,big,blockquote,body,canvas,caption,center,cite,code,dd,del,details,dfn,div,dl,dt,em,embed,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,html,i,iframe,img,ins,kbd,label,legend,li,mark,menu,nav,object,ol,output,p,pre,q,ruby,s,samp,section,small,span,strike,strong,sub,summary,sup,table,tbody,td,tfoot,th,thead,time,tr,tt,u,ul,var,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:after,blockquote:before,q:after,q:before{content:'';content:none}table{border-collapse:collapse;border-spacing:0}

body {
	color: #333;
}
#wrapper {
	margin: 0 auto;
	padding: 0;
	width: 100%;
}
h1 {
	font-family: Georgia, serif;
	font-weight: bold;
	/*margin-top: 12px; margin-bottom: 12px;*/
	/*39 = 12 + 15 + 12*/
	line-height: 39px;

	font-family: monospace;
	font-size: 15px;

	padding: 0 5px;
}
a {
	text-decoration: none;
	color: #0000EE;
}
a:hover {
	color: #333;
}
#grun-link {
	word-wrap: break-word;
}
#dbg {
	word-wrap: break-word;
}
#dbg2 {
	font-size: 22px;
	font-family: monospace;
	font-size: 15px;
}
textarea {
	font-family: monospace;
	font-size: 15px;
	width: 100%;
	/*max-width: 100%;*/
	height: auto;
	overflow-y: hidden;

	/*border: none;*/
	/*padding: 3px;*/
	/*margin: 0;*/
	/*box-sizing: content-box;*/
	box-sizing: border-box;

	padding: 4px;
}
.internal-link {
	/*text-decoration: none;*/
	/*border-bottom: 1px dashed #ccc;*/
	/*font-size: 22px;*/
}
#update-notif {
	opacity: 0;
	/*font-style: italic;*/
}
.madeby {
	transform-origin: 0 1;
	transform: rotate(-90deg);
}
.links {
	font-size: 20px;
	font-family: Georgia, serif;

	font-family: monospace;
	font-size: 15px;
}
#link-1,
#link-2 {
	/*display: inline-block;*/
	/*transition: all 0.5s;*/
}
#total-time {
	font-weight: bold;
	padding: 0 5px;
	color: black;
	background: #ddd;
}
#segmented-times {
	font-size: 22px;
	font-family: monospace;
	font-size: 15px;
}
.rotate {
  transition: 0.4s;
  transform:rotate(360deg);
}
input[type="button"] {
	background: #999;
	font-family: monospace;
	font-size: 15px;
}
#copy-input {
	width: 1px;
	height:  1px;
	background: #fff;
	border: none;
}
#save-btn {
	display: inline-block;
	padding: 0 9px;
}
#save-btn:hover {
}

.right-left {
	display: flex;
	margin-top: 12px;
}
.left {
	/*float: left;*/
	flex-grow: 1;
}
.right {
	/*width: 80px;*/
	/*float: right;*/
}

@media (prefers-color-scheme: dark) {
	body {
		background: #444;
	}
	h1 {
		/*font-family: sans-serif;*/
	}
	h1, div, p {
		color: #ccc;
	}
	textarea {
		/*background: #555;*/
		background: #444;
		color: #ccc;
	}
	a {
		color: #92A9BD;
	}
	a:hover {
		color: #ccc;
	}
	#total-time {
		color: black;
		background: #999;
	}
	#copy-input {
		width: 1px;
		background: #444;
		border: none;
	}
	#save-btn {
		background: #333;
	}
}
@media screen and (min-width: 600px) {
	#wrapper {
		width: 600px;
	}
}
</style>

<script type="text/javascript" src="decimal.min.js"></script>

<script type="text/javascript">
function onLoad() {
	window._onLoad(); // for MSIE
}	
</script>

</head>

<body onload="onLoad()">

<div id="wrapper">
<h1>Split Time Calculator</h1>

<div style="display: none">
<div class="links">
	<span id="link-1">üîó</span><a href="" class="internal-link" id="perm-link">Permanent link</a>
	&nbsp;
	<span id="link-2">üîó</span><a href="" class="internal-link" id="grun-link" target="_blank">Grun1</a>
	<span id="update-notif">‚Üê Updated</span>
</div>
</div>

<textarea id="time-edit" rows="10" placeholder=""></textarea>

<div class="right-left">
	<div class="left">

		<div id="dbg2">
			<span id="total-time">0</span>
			<span id="segmented-times"></span>
		</div>

	</div>
	<div class="right" style="font-family: monospace; font-size: 15px;">
		<!-- <input type="button" name="" value="Save"> -->
		<!-- <a href="" style="background: #333;">[grun1]</a> -->
		<a href="" target="_blank" id="grun-link-2">grun1</a>
		<a href="" id="save-btn" style="">Save</a>
	</div>
</div>

<br>
<input type="text" name="" id="copy-input" value="" style="">

</div>

<div style="display: none;">
<br>
<div id="dbg"></div>
<br>
<div id="grun-link-xxx"></div>
</div>

</div>

</body>

<script type="text/javascript">

const log = console.log;
const $dbg = document.getElementById('dbg');
const $dbg2 = document.getElementById('dbg2');
const $timeEdit = document.getElementById('time-edit');
const $totalTime = document.getElementById('total-time');
const $grunLink = document.getElementById('grun-link');
const $permLink = document.getElementById('perm-link');
const $updateNotif = document.getElementById('update-notif');
const $link1 = document.getElementById('link-1');
const $link2 = document.getElementById('link-2');
const $segmentedTimes = document.getElementById('segmented-times');
const $saveBtn = document.getElementById('save-btn');
const $copyInput = document.getElementById('copy-input');
const $grunLink2 = document.getElementById('grun-link-2');
var gPermUrl = '';
var gGrunUrl = '';
const gSiteTitle = 'Time Calculator';

const placeholder = "Example:\n\n" +
"1:11 Paris\n" +
"1:56.999 Sapienza";

function encode_ascii85(a) {
  var b, c, d, e, f, g, h, i, j, k;
  for (!/[^\x00-\xFF]/.test(a), b = "\x00\x00\x00\x00".slice(a.length % 4 || 4), a += b, 
  c = [], d = 0, e = a.length; e > d; d += 4) f = (a.charCodeAt(d) << 24) + (a.charCodeAt(d + 1) << 16) + (a.charCodeAt(d + 2) << 8) + a.charCodeAt(d + 3), 
  0 !== f ? (k = f % 85, f = (f - k) / 85, j = f % 85, f = (f - j) / 85, i = f % 85, 
  f = (f - i) / 85, h = f % 85, f = (f - h) / 85, g = f % 85, c.push(g + 33, h + 33, i + 33, j + 33, k + 33)) :c.push(122);
  return function(a, b) {
    for (var c = b; c > 0; c--) a.pop();
  }(c, b.length), "<~" + String.fromCharCode.apply(String, c) + "~>";
}

function decode_ascii85(a) {
  var c, d, e, f, g, h = String, l = "length", w = 255, x = "charCodeAt", y = "slice", z = "replace";
  for ("<~" === a[y](0, 2) && "~>" === a[y](-2), a = a[y](2, -2)[z](/\s/g, "")[z]("z", "!!!!!"), 
  c = "uuuuu"[y](a[l] % 5 || 5), a += c, e = [], f = 0, g = a[l]; g > f; f += 5) d = 52200625 * (a[x](f) - 33) + 614125 * (a[x](f + 1) - 33) + 7225 * (a[x](f + 2) - 33) + 85 * (a[x](f + 3) - 33) + (a[x](f + 4) - 33), 
  e.push(w & d >> 24, w & d >> 16, w & d >> 8, w & d);
  return function(a, b) {
    for (var c = b; c > 0; c--) a.pop();
  }(e, c[l]), h.fromCharCode.apply(h, e);
}

function encode(unicode) {
	return btoa(unescape(encodeURIComponent(unicode)));
}

function decode(b64) {
	return decodeURIComponent(escape(window.atob(b64)));
}

function hmsToSeconds(hmsMillis) {
	var hms = hmsMillis;
	var dot = hms.indexOf('.');
	var decimalMillis = new Decimal('0');
	if (dot >= 0) {
		hms = hmsMillis.substring(0, dot);
		decimalMillis = new Decimal('0' + hmsMillis.substring(dot));
	}

	const words = hms.split(/:/);
	var totalSeconds = 0;
	for (i in words) {
		const word = words[i];
		const mul = Math.pow(60, words.length - i - 1);
		const n = parseInt(word, 10);
		totalSeconds += (n * mul);
	}
	let intPart = isNaN(totalSeconds) ? 0 : totalSeconds;
	return new Decimal(intPart).add(decimalMillis);
}

function intToStr(n) {
	// avoid scientific notation
	// return n.toLocaleString('fullwide', {useGrouping: false});
	return BigInt(n).toString();
}

var toHmsInt = (secs) => {
	if (secs <= 0) {
		return '0';
	}

	var s = '';
	var force = false;
	var div = Math.floor(secs / 3600);
	var rem = secs % 3600;
	if (div > 0) {
		s += (div < 10) ? ('0'+div) : intToStr(div);
		force = true;
	}

	rem = Math.floor(rem / 60);
	if (rem > 0 || force) {
		if (s.length > 0) s += ':';
		s += (rem < 10) ? ('0'+rem) : rem;
		force = true;
	}
	
	rem = secs % 60;
	if (rem > 0 || force) {
		if (s.length > 0) s += ':';
		s += (rem < 10) ? ('0'+rem) : rem;
	}
	
	return s;
}

function toHms(secs) {
	const jsInt = Math.floor(secs.toNumber());
	// const integer = secs.truncated();
	const s = secs.toString();
	const dot = s.indexOf('.');
	const floatPart = dot >= 0 ? s.substring(dot+1) : '';
	let res = toHmsInt(jsInt);
	res += floatPart ? ('.' + floatPart) : '';
	// log('toHms', secs.toString(), '=>', res.toString());
	// log('integer', integer);
	return res;
}

function makeGrunUrl(timeAndLabel) {
	if (timeAndLabel.length === 0) {
		return null;
	}
	var query = '';
	for (var i = 0; i < timeAndLabel.length; i++) {
		if (i > 0) {
			query += '&';
		}
		const secStr = toHms(timeAndLabel[i][0]);
		const label = timeAndLabel[i][1];
		query += 't' + (i+1) + '=' + secStr;
		query += '&c' + (i+1) + '=' + encodeURIComponent(label);
	}
	return 'http://www.grun1.com/utils/timeCalc.html?' + query;
}

function recalcTime(timeText, isOnLoad) {
	const lines = timeText.split(/\r?\n/);
	var totalSeconds = new Decimal('0');
	var segmentTotal = new Decimal('0');
	const timeAndLabel = [];
	const segmentTimes = [];
	var pageTitle = '';
	var numSplits = 0;
	for (i in lines) {
		var line = lines[i];
		line = line.trim();
		if (!line && segmentTotal > 0) {
			segmentTimes.push(segmentTotal);
			segmentTotal = new Decimal('0');
			continue;
		}
		const m = line.match(/^\s*([0-9][0-9:]*(\.[0-9]+)?)(\s*(.+))?$/);
		if(m) {
			const timeHms = m[1];
			const lineLabel = (m[3] !== undefined) ? m[3].trim() : '';
			const lineSec = hmsToSeconds(timeHms);
			const neu = totalSeconds.add(lineSec);
			// log(totalSeconds.toString(), '+', lineSec.toString(), '=', neu.toString());
			totalSeconds = neu;
			segmentTotal = segmentTotal.add(lineSec);
			numSplits += 1;
			timeAndLabel.push([lineSec, lineLabel]);
			if (lineLabel && !pageTitle) {
				pageTitle = lineLabel;
			}
		}
	}
	if (segmentTotal > 0) {
		segmentTimes.push(segmentTotal);
		// segmentTotal = 0;
	}

	if (segmentTimes.length > 1) {
		const text = segmentTimes.map(t => toHms(t)).join(" + ");
		$segmentedTimes.innerHTML = '= ' + text;
	} else {
		$segmentedTimes.innerHTML = 'total';
	}

	// log('totalSeconds', totalSeconds.toString());

	const grunUrl = makeGrunUrl(timeAndLabel);
	const totalHms = toHms(totalSeconds);
	$totalTime.innerHTML = totalHms;
	
	gGrunUrl = grunUrl;
	$grunLink.setAttribute('href', grunUrl ? grunUrl : '');
	$grunLink2.setAttribute('href', grunUrl ? grunUrl : '');

	if (pageTitle) {
		if (numSplits > 1) {
			pageTitle += ' +' + (numSplits-1);
		}
		pageTitle += ', ' + totalHms;
		pageTitle += ' - ';
	}
	pageTitle += gSiteTitle;
	document.title = pageTitle;
}

function updateUrl(timeText, isOnLoad) {
	const b64 = encode(timeText);
	const url = document.location.protocol + '//' + document.location.host +
	            document.location.pathname + (b64 ? '#' + b64 : '');
	gPermUrl = url;
	$permLink.setAttribute('href', url);
	$saveBtn.setAttribute('href', url);
	window.history.replaceState({} , gSiteTitle, url);
}

function changeTimeEditSize() {
  $timeEdit.style.height = "auto";
  $timeEdit.style.height = $timeEdit.scrollHeight + "px";
}

function readTimeTextFromUrl() {
	var val = document.location.hash;
	val = (val && val.startsWith('#')) ? val.substring(1) : '';
	return val ? decode(val) : val;
}

function onSaveButton(e) {
	const anyMod = e.metaKey || e.shiftKey || e.ctrlKey || e.altKey;
	if (anyMod) {
		return;
	}
	e.preventDefault();
	$copyInput.value = gPermUrl;
	$copyInput.select();
	document.execCommand('copy');
	$timeEdit.focus();
}

window._onLoad = function() {
	Decimal.set({precision: 128});

	//const urlParams = new URLSearchParams(window.location.search);
	$timeEdit.focus();

	const textPlain = readTimeTextFromUrl();
	$timeEdit.value = textPlain;
	recalcTime(textPlain, true);
	if (textPlain) {
		updateUrl(textPlain, true);
	}
	changeTimeEditSize();

	$timeEdit.addEventListener('input', function(e) {
		const timeText = $timeEdit.value;
		recalcTime(timeText, false);
		updateUrl(timeText, false);
		changeTimeEditSize();
	}, false);

	$saveBtn.addEventListener("click", onSaveButton, false);

	document.addEventListener("keydown", function(e) {
	  if ((window.navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)  && e.keyCode == 83) {
	    e.preventDefault();
	    log('Ctrl+S');
	  }
	}, false);

	$timeEdit.setAttribute('placeholder', placeholder);
}
</script>
