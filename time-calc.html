<!--
- put some text into the title
- disallow url ending with '#'
- use prefix like 't:'
- force unix line ending?
+ use pixels everywhere, not em
- bug: "sapienza" in title when text is '111. Paris\n222 Sapienza'
- go base85 ?
- total-time: adjust the light theme
- monospace everywhere?
- handle Ctrl/Cmd+S ?
- pageTitle: limit length
- pageTitle: strip punctuation
- favicon
+ textarea takes 606px
-->

<!DOCTYPE html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Time Calculator</title>
<link rel="icon" type="image/png" sizes="16x16" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAQK0lEQVRYCQEgEN/vAf39/f8AAAAAAAAAAAAAAAD///8AAAAAAAEBAQAAAAAAAAAAAP///wAAAAAAAQEBAAAAAAAAAAAA////AAAAAAABAQEAAAAAAAAAAAD///8AAAAAAAEBAQAAAAAAAAAAAP///wAAAAAAAQEBAAAAAAAAAAAA////AAAAAAABAQEAAf39/f////8AAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAABAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAANzc3ACenp4A+/v7AAAAAAAAAAAAAQEBAAQEBABkZGQAIiIiAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAAAAAAAAAAAABAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////AMjIyADOzs4AAQEBAP///wABAQEAAAAAAAAAAADGxsYAIiIiAP///wABAQEAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAAAAAAAAv///wABAQEAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAQEBAABAQEA////AAEBAQD///8AAAAAAP///wAEBAQA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAP///wABAQEABAAAAAAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAElJSQABAQEA+fn5AKqqqgAAAAAAVlZWAAcHBwBHR0cAAQEBAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAf39/f////8AAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8A////ANTU1AAAAAAALCwsAAEBAQABAQEAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAABAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAA////AN3d3QDPz88A3t7eAO7u7gABAQEAERERACIiIgAyMjIAIiIiAAEBAQD///8AAQEBAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAAAAAAAAAAAAAf39/f/+/v4AAQEBAAAAAAAAAAAAAAAAALa2tgDf398AZGRkAAYGBgDHx8cApqamANzc3AAAAAAAAQEBAAAAAAAAAAAAAAAAAP///wAAAAAAJCQkAFtbWwA4ODgA+vr6AJycnAAiIiIASEhIAAEBAQAAAAAAAAAAAAAAAAAAAAAABP///wABAQEAAAAAAAAAAAAAAAAA5ubmAJOTkwAvLy8A9PT0AJeXlwDExMQAAAAAABAQEAA6OjoAKSkpABISEgAAAAAA7e3tANjY2ADGxsYA3NzcAIGBgQA9PT0AaGhoAOTk5AC0tLQALy8vABoaGgAAAAAAAAAAAP///wACAgIAAPz8/P/8/Pz//Pz8//z8/P/7+/v/+Pj4/5ubm//m5ub/ZmZm/0RERP9PT0//ra2t//b29v/8/Pz/+/v7//z8/P/8/Pz//Pz8//z8/P/29vb/ra2t/09PT/9FRUX/ZmZm/+Xl5f+cnJz/+Pj4//z8/P/8/Pz/+/v7//z8/P/9/f3/Af39/f////8AAAAAAP///wABAQEAAAAAAPv7+wB3d3cA19fXABwcHACCgoIAGRkZAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAP///wDj4+MAHh4eAObm5gB/f38A5OTkACkpKQCJiYkABQUFAAAAAAD///8AAQEBAAAAAAAAAAAAAgAAAAAAAAAA////AAEBAQAAAAAAAAAAAKampgDX19cAFhYWAImJiQAZGRkAAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////ANHR0QCFhYUAAAAAABoaGgCIiIgAFRUVANfX1wCnp6cAAAAAAP///wABAQEAAAAAAAAAAAAAAAAAAgAAAAD///8AAQEBAAAAAAAAAAAA6+vrAK6urgABAQEAdXV1ABISEgAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8A////AJ6engBbW1sAAAAAAP///wATExMAdXV1AAEBAQCtra0A7OzsAAEBAQAAAAAAAAAAAAAAAAAAAAAAAv///wABAQEAAAAAAAAAAAAAAAAAt7e3APr6+gA7OzsALCwsAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAP///wABAQEAxcXFAP///wA8PDwA////AAEBAQAAAAAALS0tADs7OwD6+voAtra2AAAAAAAAAAAAAAAAAP///wABAQEAAgAAAAAAAAAAAAAAAAAAAAD///8AxMTEAP///wBMTEwAAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////AAEBAQD8/PwAoaGhAGFhYQABAQEAAQEBAAAAAAAAAAAAAAAAAEtLSwD///8AxMTEAP///wAAAAAA////AAEBAQAAAAAAAgEBAQAAAAAAAAAAAP///wD09PQA4+PjAAkJCQArKysA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAC5ubkAFhYWADExMQABAQEAAAAAAAAAAAAAAAAA////ACwsLAAJCQkA4+PjAPT09AD///8AAQEBAAAAAAAAAAAAAgAAAAAAAAAA////AAEBAQDo6OgA////ABoaGgADAwMAAQEBAAAAAAAAAAAAAAAAAP///wABAQEA7+/vAHh4eACbm5sAUFBQAAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAQEBAAaGhoA////AOjo6AABAQEAAAAAAAAAAAD///8AAgAAAAD///8AAQEBAAAAAAD5+fkAAQEBAAsLCwABAQEAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAv7+/ANHR0QD5+fkA29vbAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAAAAAAAKCgoAAQEBAPj4+AAAAAAAAAAAAAAAAAAAAAAABP///wABAQEAAAAAAAAAAAAGBgYA////APX19QAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAALi4uAAkJCQD+/v4AMTExAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD29vYA////AAgICAAAAAAAAAAAAP///wACAgIABAAAAAAAAAAAAAAAAAAAAAAZGRkAAQEBAObm5gD8/PwABAQEAP///wABAQEAAAAAAAAAAAAAAAAAIyMjAKSkpAAAAAAACgoKAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAPv7+wDm5uYAAQEBABkZGQAAAAAA////AAEBAQAAAAAAAgEBAQAAAAAAAAAAAP///wAMDAwAHR0dAPf39wDU1NQA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAoKCgAKCgoAAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////ANXV1QD39/cAHR0dAAsLCwD///8AAQEBAAAAAAAAAAAAAgAAAAAAAAAA////AAEBAQABAQEAPDw8AAEBAQC1tbUAAQEBAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBALW1tQABAQEAPDw8AAAAAAABAQEAAAAAAAAAAAD///8AAgAAAAD///8AAQEBAAAAAAAAAAAASkpKAAUFBQDFxcUA09PTAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAP///wABAQEA1NTUAMXFxQAGBgYASUlJAAEBAQAAAAAAAAAAAAAAAAAAAAAAAv///wABAQEAAAAAAAAAAAAAAAAAExMTAFRUVAD///8Ai4uLAO3t7QD///8AAQEBAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////AAEBAQDu7u4AioqKAP///wBTU1MAFRUVAAAAAAAAAAAAAAAAAP///wABAQEAAgAAAAAAAAAAAAAAAAAAAAD///8AAQEBAFlZWQApKSkA6urqAHh4eADo6OgAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAOfn5wB3d3cA6+vrACkpKQBZWVkAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAf39/f////8AAAAAAP///wABAQEAAAAAAAAAAADx8fEAeXl5AN/f3wAKCgoAXl5eAElJSQAFBQUAAQEBAAAAAAAAAAAAAAAAAP///wD7+/sAt7e3AKKiogD29vYAIiIiAIaGhgAPDw8AAAAAAAAAAAD///8AAQEBAAAAAAABAQEAAf39/f////8A////AAEBAQAAAAAAAAAAAAAAAAD///8A9vb2AJCQkADDw8MAAAAAABAQEAA5OTkAKioqABMTEwAAAAAA7OzsANfX1wDHx8cA8PDwAAAAAAA9PT0AcHBwAAsLCwAAAAAAAAAAAP///wABAQEAAAAAAAAAAAAAAAAAAf39/f/+/v4AAQEBAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAP///wDIyMgApaWlANzc3AABAQEAAAAAAAAAAAAAAAAA////AAEBAQD///8AJSUlAFpaWgA4ODgAAQEBAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAAAAAAAAfz8/P8AAAAAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8AAAAAAN7e3gDNzc0A4ODgAO/v7wAAAAAAERERACAgIAA0NDQAISEhAAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAP///wACAgIAAfz8/P8AAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////AAEBAQAAAAAAAAAAAAAAAAD///8AAQEBAAAAAAAAAAAAAAAAAP///wABAQEAAAAAAAAAAAAAAAAA////AAEBAQABAQEAAf39/f////8AAAAAAAAAAAABAQEAAAAAAP///wAAAAAAAAAAAAEBAQAAAAAA////AAAAAAAAAAAAAQEBAAAAAAAAAAAA////AAAAAAABAQEAAAAAAAAAAAD///8AAAAAAAEBAQAAAAAAAAAAAP///wAAAAAAAQEBAAAAAAAAAAAAEC7fjCA/SokAAAAASUVORK5CYII=" />
<style type="text/css">
body {
	color: #333;
}
#wrapper {
	margin: 0 auto;
	padding: 0;
	width: 100%;
}
h1 {
	font-family: Georgia, serif;
	font-weight: bold;
	margin-bottom: 4px;

	font-family: monospace;
	font-size: 15px;
}
a {
	text-decoration: none;
	color: #0000EE;
}
a:hover {
	color: #333;
}
#grun-link {
	word-wrap: break-word;
}
#dbg {
	word-wrap: break-word;
}
#dbg2 {
	font-size: 22px;
	font-family: monospace;
	font-size: 15px;
}
textarea {
	font-family: monospace;
	font-size: 15px;
	width: 100%;
	/*max-width: 100%;*/
	height: auto;

	/*border: none;*/
	/*padding: 3px;*/
	/*margin: 0;*/
	/*box-sizing: content-box;*/
	box-sizing: border-box;
}
.internal-link {
	/*text-decoration: none;*/
	/*border-bottom: 1px dashed #ccc;*/
	/*font-size: 22px;*/
}
#update-notif {
	opacity: 0;
	/*font-style: italic;*/
}
.madeby {
	transform-origin: 0 1;
	transform: rotate(-90deg);
}
.links {
	font-size: 20px;
	font-family: Georgia, serif;

	font-family: monospace;
	font-size: 15px;
}
#link-1,
#link-2 {
	/*display: inline-block;*/
	/*transition: all 0.5s;*/
}
#total-time {
	font-weight: bold;
	padding: 0 4px;
	color: black;
	background: #999;
}
#segmented-times {
	font-size: 22px;
	font-family: monospace;
	font-size: 15px;
}
.rotate {
  transition: 0.4s;
  transform:rotate(360deg);
}
input[type="button"] {
	background: #999;
	font-family: monospace;
	font-size: 15px;
}
@media (prefers-color-scheme: dark) {
	body {
		background: #444;
	}
	h1 {
		/*font-family: sans-serif;*/
	}
	h1, div, p {
		color: #ccc;
	}
	textarea {
		background: #555;
		color: #ccc;
	}
	a {
		color: #92A9BD;
	}
	a:hover {
		color: #ccc;
	}
}
@media screen and (min-width: 600px) {
	#wrapper {
		width: 600px;
	}
}

.right-left {
	display: flex;
}
.left {
	/*float: left;*/
	flex-grow: 1;
}
.right {
	/*width: 80px;*/
	/*float: right;*/
}
</style>
</head>
<body onload="onLoad()">

<div id="wrapper">
<h1>Split Time Calculator</h1>

<div style="display: none">
<div class="links">
	<span id="link-1">üîó</span><a href="" class="internal-link" id="perm-link">Permanent link</a>
	&nbsp;
	<span id="link-2">üîó</span><a href="" class="internal-link" id="grun-link" target="_blank">Grun1</a>
	<span id="update-notif">‚Üê Updated</span>
</div>
</div>

<br>
<textarea id="time-edit" rows="10" placeholder="Type in text like this:

1:11 Paris
1:56 Sapienza

0:34 Dubai
1:55 Dartmoor"></textarea>
<br>
<br>
<div class="right-left">
	<div class="left">

		<div id="dbg2">
			<span id="total-time">0</span>
			<span id="segmented-times"></span>
		</div>

	</div>
	<div class="right" style="font-family: monospace; font-size: 15px;">
		<!-- <input type="button" name="" value="Save"> -->
		<!-- <a href="" style="background: #333;">[grun1]</a> -->
		<a href="">&nbsp;grun1&nbsp;</a>
		<a href="" style="background: #333;">&nbsp;Save&nbsp;</a>
	</div>
</div>
<!-- <br> -->
<!-- <div id="segmented-times" style="margin-top: 10px;"> -->
	&nbsp;
</div>

<div style="display: none;">
<br>
<div id="dbg"></div>
<br>
<div id="grun-link-xxx"></div>
</div>

<!-- <br>
<div>Written by <a href="https://www.speedrun.com/user/zencd" target="_blank">zencd</a>, 2022</div>
 -->
</div>

</body>

<script type="text/javascript">

const log = console.log;
const $dbg = document.getElementById('dbg');
const $dbg2 = document.getElementById('dbg2');
const $timeEdit = document.getElementById('time-edit');
const $totalTime = document.getElementById('total-time');
const $grunLink = document.getElementById('grun-link');
const $permLink = document.getElementById('perm-link');
const $updateNotif = document.getElementById('update-notif');
const $link1 = document.getElementById('link-1');
const $link2 = document.getElementById('link-2');
const $segmentedTimes = document.getElementById('segmented-times');
var g_permUrl = '';
var g_grunUrl = '';

function encode_ascii85(a) {
  var b, c, d, e, f, g, h, i, j, k;
  for (!/[^\x00-\xFF]/.test(a), b = "\x00\x00\x00\x00".slice(a.length % 4 || 4), a += b, 
  c = [], d = 0, e = a.length; e > d; d += 4) f = (a.charCodeAt(d) << 24) + (a.charCodeAt(d + 1) << 16) + (a.charCodeAt(d + 2) << 8) + a.charCodeAt(d + 3), 
  0 !== f ? (k = f % 85, f = (f - k) / 85, j = f % 85, f = (f - j) / 85, i = f % 85, 
  f = (f - i) / 85, h = f % 85, f = (f - h) / 85, g = f % 85, c.push(g + 33, h + 33, i + 33, j + 33, k + 33)) :c.push(122);
  return function(a, b) {
    for (var c = b; c > 0; c--) a.pop();
  }(c, b.length), "<~" + String.fromCharCode.apply(String, c) + "~>";
}

function decode_ascii85(a) {
  var c, d, e, f, g, h = String, l = "length", w = 255, x = "charCodeAt", y = "slice", z = "replace";
  for ("<~" === a[y](0, 2) && "~>" === a[y](-2), a = a[y](2, -2)[z](/\s/g, "")[z]("z", "!!!!!"), 
  c = "uuuuu"[y](a[l] % 5 || 5), a += c, e = [], f = 0, g = a[l]; g > f; f += 5) d = 52200625 * (a[x](f) - 33) + 614125 * (a[x](f + 1) - 33) + 7225 * (a[x](f + 2) - 33) + 85 * (a[x](f + 3) - 33) + (a[x](f + 4) - 33), 
  e.push(w & d >> 24, w & d >> 16, w & d >> 8, w & d);
  return function(a, b) {
    for (var c = b; c > 0; c--) a.pop();
  }(e, c[l]), h.fromCharCode.apply(h, e);
}

function encode(unicode) {
	return btoa(unescape(encodeURIComponent(unicode)));
}

function decode(b64) {
	return decodeURIComponent(escape(window.atob(b64)));
}

function hmsToSeconds(hms) {
	const words = hms.split(/:/);
	var totalSeconds = 0;
	for (i in words) {
		const word = words[i];
		const mul = Math.pow(60, words.length - i - 1);
		const n = parseInt(word, 10);
		totalSeconds += (n * mul);
	}
	return isNaN(totalSeconds) ? 0 : totalSeconds;
}

var toHHMMSS = (secs) => {
	if (secs <= 0) {
		return '0';
	}
	var parts = [];
	while (secs > 0) {
		var ostatok = secs % 60;
		secs = Math.floor(secs / 60);
		parts.push(ostatok);
	}
	parts.reverse();
  return parts
      .map(v => v < 10 ? "0" + v : v)
      .filter((v,i) => v !== "00" || i > 0)
      .join(":")
}

function animateUpdateImpl($elem) {
	$elem.animate({ opacity: [0, 1.0, 0] }, { duration: 3000, iterations: 1, easing: "ease-out" })
	.onfinish = (e) => {
		e.target.effect.target.style.opacity = 0;
	};
}

var updTimeoutHandle = null;

function animateUpdate($elem) {
	// log('animateUpdate: updTimeoutHandle:', updTimeoutHandle);
	if (updTimeoutHandle) {
		clearTimeout(updTimeoutHandle);
		updTimeoutHandle = null;
	}
	updTimeoutHandle = setTimeout(function() {
		animateUpdateImpl($elem);
	}, 1200);
}

function makeGrunUrl(timeAndLabel) {
	if (timeAndLabel.length == 0) {
		return null;
	}
	var query = '';
	for (var i = 0; i < timeAndLabel.length; i++) {
		if (i > 0) {
			query += '&';
		}
		const secStr = toHHMMSS(timeAndLabel[i][0]);
		const label = timeAndLabel[i][1];
		query += 't' + (i+1) + '=' + secStr;
		query += '&c' + (i+1) + '=' + encodeURIComponent(label);
	}
	return 'http://www.grun1.com/utils/timeCalc.html?' + query;
}

function recalcTime(timeText, isOnLoad) {
	// log('timeText:', timeText);
	// const lines = timeText.match(/[^\r\n]+/g);
	const lines = timeText.split(/\r?\n/);
	//log('lines:', lines);
	var totalSeconds = 0;
	var segmentTotal = 0;
	//var grunUrl = 'http://www.grun1.com/utils/timeCalc.html?';
	const timeAndLabel = [];
	const segmentTimes = [];
	var pageTitle = '';
	for (i in lines) {
		var line = lines[i];
		line = line.trim();
		//log('line:', line);
		if (!line && segmentTotal > 0) {
			segmentTimes.push(segmentTotal);
			segmentTotal = 0;
			continue;
		}
		const m = line.match(/^\s*([0-9][0-9:]*)(\s+(.+))?/);
		if(m) {
			const timeHms = m[1];
			const lineLabel = (m[3] !== undefined) ? m[3].trim() : '';
			const lineSec = hmsToSeconds(timeHms);
			//log('line:', timeHms, lineLabel, lineSec);
			totalSeconds += lineSec;
			segmentTotal += lineSec;
			timeAndLabel.push([lineSec, lineLabel]);
			if (lineLabel && !pageTitle) {
				pageTitle = lineLabel;
			}
		}
	}
	if (segmentTotal > 0) {
		segmentTimes.push(segmentTotal);
		segmentTotal = 0;
	}

	// log('segmentTimes:', segmentTimes);
	if (segmentTimes.length > 1) {
		const text = segmentTimes.map(t => toHHMMSS(t)).join(" + ");
		$segmentedTimes.innerHTML = '= ' + text;
	} else {
		$segmentedTimes.innerHTML = 'total';
	}

	// log('timeAndLabel:', timeAndLabel);
	const grunUrl = makeGrunUrl(timeAndLabel);
	// log('grunUrl:', grunUrl);
	// log('totalSeconds:', totalSeconds);
	// log('totalSeconds:', toHHMMSS(totalSeconds));
	// log('$dbg2:', $dbg2);
	// $dbg2.innerHTML = 'Total time: ' + toHHMMSS(totalSeconds);
	const totalHms = toHHMMSS(totalSeconds);
	$totalTime.innerHTML = totalHms;
	
	g_grunUrl = grunUrl;
	// const grunAnchor = grunUrl ? '<a href="'+grunUrl+'" target="_blank">' + grunUrl + '</a>' : '-';
	// $grunLink.innerHTML = 'Grun1 link:<br>' + grunAnchor;
	$grunLink.setAttribute('href', grunUrl ? grunUrl : '');
	// if (!isOnLoad) {
	// 	animateUpdate($grunLink);
	// }

	if (pageTitle) {
		pageTitle += ', ' + totalHms;
		if (segmentTimes.length > 1) {
			pageTitle += ', ' + segmentTimes.length + ' seg'
		}
		pageTitle += ' - ';
	}
	pageTitle += 'Time Calculator'
	document.title = pageTitle;
}

function animateRotate($elem) {
	var rot = $elem.getAttribute('data-rotate');
	rot = rot ? parseInt(rot) : 360;
	$elem.style = 'transform: rotate(' + rot + 'deg)';
  $elem.setAttribute('data-rotate', rot + 360);
}

function updateUrl(timeText, isOnLoad) {
	const b64 = encode(timeText);
	const url = document.location.protocol + '//' + document.location.host + document.location.pathname + '#' + b64;
	g_permUrl = url;
	// $dbg.innerHTML = 'Permanent link:<br><a href="'+url+'">' + url + '</a>';
	$permLink.setAttribute('href', url);
	window.history.replaceState({} , 'Time Calculator', url);
	if (!isOnLoad) {
		// animateRotate($link1);
		// animateUpdate($permLink);
		animateUpdate($updateNotif);
		// $link1.classList.toggle('rotate');
	}
}

function changeTimeEditSize() {
  $timeEdit.style.height = "auto";
  $timeEdit.style.height = $timeEdit.scrollHeight + "px";
}

function readTimeTextFromUrl() {
	var val = document.location.hash;
	val = val ? val.substring(1) : '';
	return val ? decode(val) : val;
}

function copyPermanentUrl() {}

function copyGrunUrl() {}

function onLoad() {
	const urlParams = new URLSearchParams(window.location.search);
	// const t = urlParams.get('t');
	//log('t:', t);
	//log(atob);
	$timeEdit.focus();

	var textPlain = readTimeTextFromUrl();
	$timeEdit.value = textPlain;
	recalcTime(textPlain, true);
	if (textPlain) {
		updateUrl(textPlain, true);
	}
	changeTimeEditSize();

	$timeEdit.addEventListener('input', function(e) {
		const timeText = $timeEdit.value;
		recalcTime(timeText, false);
		updateUrl(timeText, false);
		changeTimeEditSize();
	}, false);

	document.addEventListener("keydown", function(e) {
	  if ((window.navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)  && e.keyCode == 83) {
	    e.preventDefault();
	    log('Ctrl+S');
	  }
	}, false);
}
</script>
